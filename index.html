<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pubgolf App</title>
    <!-- PWA / Mobiele App Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pubgolf">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" id="theme-color-meta" content="#4CAF50">

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5; --element-bg: #ffffff; --text-color: #212529; --border-color: #dee2e6;
            --header-bg: #4CAF50; --header-text: #ffffff; --accent-color: #1976D2; --locked-bg: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }
        html.dark-mode {
            --bg-color: #121212; --element-bg: #1e1e1e; --text-color: #e0e0e0; --border-color: #424242;
            --header-bg: #388E3C; --accent-color: #42A5F5; --locked-bg: #333333;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 10px; -webkit-font-smoothing: antialiased; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1200px; margin: auto; background: var(--element-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); transition: background-color 0.3s; }
        h1, h2, h3 { text-align: center; color: var(--header-bg); margin-top: 10px; margin-bottom: 15px; }
        h3 { color: var(--text-color); }
        #map { height: 350px; width: 100%; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #e9e9e9; }
        html.dark-mode #map { filter: invert(1) hue-rotate(180deg); }
        #route-info { text-align: center; font-size: 1.1em; font-weight: bold; color: var(--accent-color); margin-bottom: 20px; }
        .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .controls-row { display: flex; gap: 10px; }
        input, button, textarea { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; -webkit-appearance: none; background-color: var(--element-bg); color: var(--text-color); font-family: inherit; }
        button { background-color: var(--header-bg); color: var(--header-text); cursor: pointer; border: none; transition: background-color 0.2s, transform 0.1s; font-weight: bold; }
        button:disabled { background-color: #9E9E9E; cursor: not-allowed; }
        button:active { transform: scale(0.98); }
        button:hover:not(:disabled) { background-color: #45a049; }
        html.dark-mode button:hover:not(:disabled) { background-color: #2E7D32; }
        .icon-button { background: none; border: none; padding: 5px; width: auto; cursor: pointer; opacity: 0.7; }
        .icon-button:hover { opacity: 1; }
        .icon-button svg { width: 24px; height: 24px; fill: var(--text-color); }
        #header-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border-color); }
        th { background-color: var(--header-bg); color: var(--header-text); position: sticky; top: 0; z-index: 10; }
        .hole-row.locked { background-color: var(--locked-bg); }
        .hole-row.active-hole { background-color: var(--header-bg) !important; color: var(--header-text) !important; }
        .hole-row.active-hole input, .hole-row.active-hole textarea { background-color: #fff2; color: var(--header-text); border-color: #fff5; }
        .hole-row.active-hole ::placeholder { color: #fffa; }
        .hole-row.active-hole .icon-button svg { fill: var(--header-text); }
        .hole-row.active-hole .drag-handle svg { fill: var(--header-text) !important; }
        .score-input { text-align: center !important; font-weight: bold; border-radius: 20px; padding: 8px 0; width: 60px !important; }
        .drag-handle { width: 40px; cursor: move; vertical-align: middle; }
        .drag-handle svg { width: 20px; height: 20px; fill: #888; }
        .hole-row.locked .drag-handle { cursor: default; } .hole-row.locked .drag-handle svg { fill: #bbb; }
        #setup-screen, #game-screen { transition: opacity 0.3s; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--element-bg); margin: 20% auto; padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 12px; position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #rules-text { width: 100%; min-height: 200px; margin-top: 15px; }
        #qrcode-container { display: flex; justify-content: center; padding: 20px; }
        .ranking-list { list-style: none; padding: 0; margin-top: 15px; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-name { font-weight: bold; }
        .ranking-score { font-size: 1.2em; }
        .ranking-emoji { font-size: 1.5em; width: 30px; text-align: center; }
        #player-setup-list { list-style: none; padding: 0; margin: 20px 0; }
        #player-setup-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 5px; }
        
        @media (max-width: 768px) {
            body { padding: 5px; } .container { padding: 10px; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; position: relative; padding: 10px; padding-top: 45px; }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 120px !important; text-align: right !important; min-height: 48px; display: flex; align-items: center; justify-content: flex-end; }
            td:before { content: attr(data-label); position: absolute; left: 10px; width: 100px; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; }
            td:last-child { border-bottom: none; }
            .score-input { width: 80px !important; padding: 8px; text-align: center; }
            .drag-handle { position: absolute; top: 0; left: 0; height: 40px; width: 40px; display: flex !important; align-items: center; justify-content: center; border-bottom: none; padding: 0 !important; }
            .drag-handle:before { content: none; }
        }
        @media (min-width: 769px) { .controls { flex-direction: row; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="header-actions">
            <button id="rules-btn" class="icon-button" title="Spelregels"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg></button>
            <button id="share-btn" class="icon-button" title="Deel Spel"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L15.96,7.2C16.5,7.69 17.21,8 18,8A3,3 0 0,0 18,2A3,3 0 0,0 15,5C15,5.24 15.04,5.47 15.09,5.7L8.04,9.8C7.5,9.31 6.79,9 6,9A3,3 0 0,0 6,15A3,3 0 0,0 9,12.08L16.14,16.25C16.09,16.5 16,16.74 16,17A3,3 0 0,0 16,23A3,3 0 0,0 19,20A3,3 0 0,0 18,16.08Z"/></svg></button>
            <button id="dark-mode-toggle" class="icon-button" title="Donkere Modus"><svg id="dark-mode-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"></svg></button>
        </div>
        <h1>Pubgolf App</h1>

        <!-- NIEUW SETUP SCHERM -->
        <div id="setup-screen">
            <h2>Nieuw Spel Opzetten</h2>
            <div class="controls">
                <div>
                    <h3>1. Kies aantal holes</h3>
                    <input type="number" id="hole-count-input" min="3" max="18" value="9">
                </div>
                <div>
                    <h3>2. Voeg spelers toe</h3>
                    <div class="controls-row">
                        <input type="text" id="player-setup-name" placeholder="Naam speler">
                        <button id="add-player-setup-btn">Voeg toe</button>
                    </div>
                    <ul id="player-setup-list"></ul>
                </div>
                <button id="start-game-btn" disabled>Start Spel</button>
            </div>
        </div>

        <div id="game-screen">
            <div id="map"></div>
            <h2 id="route-info">-</h2>
            <div class="controls"><div class="controls-row"><button id="show-totals-btn">Tussenstand</button><button id="reset-btn">Nieuw Spel</button></div></div>
            <table id="scoreboard">
                <thead><tr></tr></thead>
                <tbody id="scoreboard-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="rules-modal" class="modal"><div class="modal-content"><span id="close-rules" class="close-button">&times;</span><h2>Spelregels</h2><textarea id="rules-text" placeholder="Typ hier jullie regels..."></textarea></div></div>
    <div id="share-modal" class="modal"><div class="modal-content"><span id="close-share" class="close-button">&times;</span><h2>Deel dit spel</h2><div id="qrcode-container"></div><p style="text-align:center;">Scan met een andere telefoon.</p></div></div>
    <div id="scoreboard-modal" class="modal"><div class="modal-content"><span id="close-scoreboard" class="close-button">&times;</span><h2>Tussenstand</h2><ul id="ranking-list" class="ranking-list"></ul></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. DOM SELECTORS & STATE
    const docHtml = document.documentElement;
    const setupScreen = document.getElementById('setup-screen'), gameScreen = document.getElementById('game-screen');
    const holeCountInput = document.getElementById('hole-count-input'), startGameBtn = document.getElementById('start-game-btn');
    const addPlayerSetupBtn = document.getElementById('add-player-setup-btn'), playerSetupNameInput = document.getElementById('player-setup-name'), playerSetupList = document.getElementById('player-setup-list');
    const resetBtn = document.getElementById('reset-btn'), showTotalsBtn = document.getElementById('show-totals-btn');
    const routeInfo = document.getElementById('route-info');
    const thead = document.querySelector('#scoreboard thead tr'), tbody = document.getElementById('scoreboard-body');
    const darkModeToggle = document.getElementById('dark-mode-toggle'), darkModeIcon = document.getElementById('dark-mode-icon');
    const rulesBtn = document.getElementById('rules-btn'), rulesModal = document.getElementById('rules-modal'), closeRules = document.getElementById('close-rules'), rulesText = document.getElementById('rules-text');
    const shareBtn = document.getElementById('share-btn'), shareModal = document.getElementById('share-modal'), closeShare = document.getElementById('close-share'), qrcodeContainer = document.getElementById('qrcode-container');
    const scoreboardModal = document.getElementById('scoreboard-modal'), closeScoreboard = document.getElementById('close-scoreboard'), rankingList = document.getElementById('ranking-list');
    let map, directionsService, directionsRenderer, playerCount = 0, markers = [], holeLocations = {};
    let setupPlayers = [];

    const ICONS = {
        sun: '<path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,4.39L17.66,4.39L19.61,7.24L20.5,10.5L19.61,13.76L17.66,16.61L14.39,16.61L12,19L9.61,16.61L6.34,16.61L4.39,13.76L3.5,10.5L4.39,7.24L6.34,4.39L9.61,4.39L12,2M12,4.15L10.74,6.24L8.3,6.63L9.73,8.79L9.11,11.21L11.2,12.5L13.28,11.21L12.67,8.79L14.1,6.63L11.65,6.24L12,4.15Z" />',
        moon: '<path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.13,4.2 8.05,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.25 16.1,16.2 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.47C7.36,12.31 6.19,9.5 6.03,6.67C6.04,6.62 6.05,6.56 6.07,6.52C6.1,6.43 6.13,6.34 6.17,6.26C6.25,6.09 6.35,5.92 6.46,5.77C6.56,5.62 6.68,5.48 6.81,5.36C6.93,5.23 7.07,5.12 7.22,5.02C7.37,4.92 7.53,4.83 7.7,4.76C7.79,4.73 7.87,4.7 7.96,4.67C8.01,4.65 8.06,4.64 8.11,4.63C8.2,4.61 8.29,4.59 8.39,4.58C8.52,4.56 8.66,4.55 8.79,4.55C9.07,4.55 9.34,4.58 9.6,4.63C9.64,4.64 9.69,4.65 9.73,4.65C9.78,4.66 9.83,4.67 9.87,4.68C10.11,4.73 10.35,4.8 10.58,4.88C15.63,6.25 18.75,11.37 17.33,17.97Z" />'
    };

    // 2. INITIALIZATION
    window.initMap = function() {
        map = new google.maps.Map(document.getElementById('map'), { center: { lat: 52.1326, lng: 5.2913 }, zoom: 7, mapTypeControl: false, streetViewControl: false, gestureHandling: 'greedy' });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#1976D2', strokeOpacity: 0.8, strokeWeight: 6 }, map: map });
        loadGameState();
        initUI();
    };

    function initUI() {
        const isDarkMode = localStorage.getItem('pubgolfDarkMode') === 'true';
        if (isDarkMode) docHtml.classList.add('dark-mode');
        updateDarkModeIcon(isDarkMode);
        const savedRules = localStorage.getItem('pubgolfRules');
        if (savedRules) rulesText.value = savedRules;
    }

    // 3. DATA PERSISTENCE
    function saveGameState() {
        const state = { players: [], holes: [], holeLocations, playerCount, activeHoleIndex: -1, rules: rulesText.value };
        const activeHoleRow = tbody.querySelector('.active-hole');
        if (activeHoleRow) state.activeHoleIndex = Array.from(tbody.children).indexOf(activeHoleRow);
        thead.querySelectorAll('th.player-header').forEach(th => state.players.push(th.textContent));
        tbody.querySelectorAll('.hole-row').forEach(row => {
            const holeData = {
                originalIndex: row.dataset.originalIndex, name: row.querySelector('.hole-input').value,
                location: row.querySelector('.location-input').value, notes: row.querySelector('.notes-input').value,
                locked: row.classList.contains('locked'), scores: {}
            };
            row.querySelectorAll('.score-input').forEach(input => { holeData.scores[input.dataset.player] = input.value; });
            state.holes.push(holeData);
        });
        localStorage.setItem('pubgolfGameState', JSON.stringify(state));
    }

    function loadGameState() {
        const savedState = localStorage.getItem('pubgolfGameState');
        if (!savedState) return;
        const state = JSON.parse(savedState);
        if (!state.holes || state.holes.length === 0) return;
        setupScreen.style.display = 'none'; gameScreen.style.display = 'block';
        holeLocations = state.holeLocations || {}; playerCount = state.playerCount || 0;
        rulesText.value = state.rules || '';
        rebuildUIFromState(state);
    }

    function rebuildUIFromState(state) {
        tbody.innerHTML = '';
        state.players.forEach(name => addPlayer(name, false));
        state.holes.forEach(holeData => tbody.appendChild(createRowFromData(holeData, state.players)));
        if (state.activeHoleIndex > -1 && tbody.children[state.activeHoleIndex]) {
            tbody.children[state.activeHoleIndex].classList.add('active-hole');
        }
        initializeDragAndDrop(); updateVisualsAfterDrag(false);
    }

    function createRowFromData(holeData, players) {
        const row = document.createElement('tr');
        row.className = 'hole-row'; if(holeData.locked) row.classList.add('locked'); row.dataset.originalIndex = holeData.originalIndex;
        row.innerHTML = `<td class="drag-handle" data-label="Verplaats"><svg viewBox="0 0 24 24"><path d="M10,4c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S11.1,4,10,4z M10,10c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S11.1,10,10,10z M10,16c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S11.1,16,10,16z M14,8c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S12.9,8,14,8z M14,10c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S15.1,10,14,10z M14,16c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S15.1,16,14,16z"/></svg><span>-</span></td>
            <td data-label="Hole"><input type="text" class="hole-input" value="${holeData.name || ''}"></td>
            <td data-label="Locatie & Nav." class="location-cell"><div style="display:flex; align-items:center; gap: 5px;"><input type="text" class="location-input" value="${holeData.location || ''}"><button class="icon-button nav-btn" title="Navigeer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z" /></svg></button></div></td>
            <td data-label="Opdracht"><input type="text" class="notes-input" placeholder="Drankje/Opdracht..." value="${holeData.notes || ''}"></td>
            <td data-label="Acties"><button class="icon-button focus-btn" title="Markeer als huidige hole"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17.3C9.03,17.3 5.7,15.35 4.17,12C5.7,8.65 9.03,6.7 12,6.7C14.97,6.7 18.3,8.65 19.83,12C18.3,15.35 14.97,17.3 12,17.3M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" /></svg></button><button class="lock-btn">${holeData.locked ? 'Heropenen' : 'Sluiten'}</button></td>`;
        if(holeData.locked) row.querySelector('.lock-btn').classList.add('reopen-btn');
        players.forEach((p, i) => { 
            const pIdx = i + 1; 
            const cell = row.insertCell(); 
            cell.dataset.label = p; 
            cell.innerHTML = `<input type="number" class="score-input" min="1" data-player="${pIdx}" value="${holeData.scores[pIdx] || ''}" placeholder="Slagen">`; 
        });        row.querySelectorAll('input').forEach(input => input.addEventListener('input', saveGameState));
        row.querySelector('.lock-btn').addEventListener('click', e => toggleHoleLock(e.target));
        row.querySelector('.focus-btn').addEventListener('click', e => toggleHoleFocus(e.target));
        row.querySelector('.nav-btn').addEventListener('click', e => navigateToHole(e.target));
        initializeAutocomplete(row.querySelector('.location-input'), holeData.originalIndex);
        return row;
    }
    // 4. CORE FUNCTIONS
    function generateHoleRows(count) {
        tbody.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const row = tbody.insertRow(); row.className = 'hole-row'; row.dataset.originalIndex = i - 1;
            row.innerHTML = `<td class="drag-handle" data-label="Verplaats"><svg viewBox="0 0 24 24"><path d="M10,4c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S11.1,4,10,4z M10,10c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S11.1,10,10,10z M10,16c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S11.1,16,10,16z M14,8c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S12.9,8,14,8z M14,10c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S15.1,10,14,10z M14,16c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S15.1,16,14,16z"/></svg><span>${i}</span></td>
                <td data-label="Hole"><input type="text" class="hole-input" placeholder="Hole ${i}"></td>
                <td data-label="Locatie & Nav." class="location-cell"><div style="display:flex; align-items:center; gap: 5px;"><input type="text" class="location-input" placeholder="Zoek locatie..."><button class="icon-button nav-btn" title="Navigeer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2Z" /></svg></button></div></td>
                <td data-label="Opdracht"><input type="text" class="notes-input" placeholder="Drankje/Opdracht..."></td>
                <td data-label="Acties"><button class="icon-button focus-btn" title="Markeer als huidige hole"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17.3C9.03,17.3 5.7,15.35 4.17,12C5.7,8.65 9.03,6.7 12,6.7C14.97,6.7 18.3,8.65 19.83,12C18.3,15.35 14.97,17.3 12,17.3M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" /></svg></button><button class="lock-btn">Sluiten</button></td>`;
            row.querySelectorAll('input').forEach(input => input.addEventListener('input', saveGameState));
            row.querySelector('.lock-btn').addEventListener('click', e => toggleHoleLock(e.target));
            row.querySelector('.focus-btn').addEventListener('click', e => toggleHoleFocus(e.target));
            row.querySelector('.nav-btn').addEventListener('click', e => navigateToHole(e.target));
            initializeAutocomplete(row.querySelector('.location-input'), i - 1);
        }
    }
    function initializeDragAndDrop() { new Sortable(tbody, { animation: 150, handle: '.drag-handle', onEnd: updateVisualsAfterDrag }); }
    function initializeAutocomplete(input, originalIndex) { const autocomplete = new google.maps.places.Autocomplete(input, { fields: ["formatted_address", "geometry", "name"], types: ["establishment", "geocode"] }); autocomplete.bindTo("bounds", map); autocomplete.addListener("place_changed", () => { const place = autocomplete.getPlace(); if (!place.geometry || !place.geometry.location) return; input.value = place.formatted_address || place.name; holeLocations[originalIndex] = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() }; updateVisualsAfterDrag(); }); }
    function updateVisualsAfterDrag(doSave = true) { updateVisualHoleNumbers(); calculateRouteAndDistance(); updateMarkers(); if (doSave) saveGameState(); }
    function calculateRouteAndDistance() { const waypoints = []; tbody.querySelectorAll('.hole-row').forEach(row => { const index = row.dataset.originalIndex; if (holeLocations[index]) waypoints.push(holeLocations[index]); }); if (waypoints.length < 2) { directionsRenderer.setDirections({routes: []}); routeInfo.textContent = '-'; return; } const request = { origin: waypoints[0], destination: waypoints[waypoints.length - 1], waypoints: waypoints.slice(1, -1).map(loc => ({ location: loc, stopover: true })), travelMode: 'WALKING' }; directionsService.route(request, (result, status) => { if (status == 'OK') { directionsRenderer.setDirections(result); let totalDistance = 0, totalDuration = 0; result.routes[0].legs.forEach(leg => { totalDistance += leg.distance.value; totalDuration += leg.duration.value; }); const totalMinutes = Math.round(totalDuration / 60); routeInfo.textContent = `Afstand: ${(totalDistance / 1000).toFixed(1)} km (~${totalMinutes} min lopen)`; } }); }
    function updateMarkers() { markers.forEach(marker => marker.setMap(null)); markers = []; const activeHole = tbody.querySelector('.active-hole'); const activeIndex = activeHole ? Array.from(tbody.children).indexOf(activeHole) : -1; tbody.querySelectorAll('.hole-row').forEach((row, visualIndex) => { const originalIndex = row.dataset.originalIndex; if (holeLocations[originalIndex]) { markers.push(new google.maps.Marker({ map, position: holeLocations[originalIndex], label: (visualIndex + 1).toString(), title: row.querySelector('.hole-input').value || `Hole ${visualIndex + 1}`, zIndex: visualIndex === activeIndex ? 100 : 1, animation: visualIndex === activeIndex ? google.maps.Animation.BOUNCE : null })); } }); }
    function updateVisualHoleNumbers() { tbody.querySelectorAll('.hole-row').forEach((row, index) => { row.querySelector('.drag-handle span').textContent = index + 1; }); }
    function addPlayer(name, doSave = true) {
        playerCount++;
        const header = Object.assign(document.createElement('th'), { 
            textContent: name, 
            className: 'player-header',
            title: 'Aantal slagen' // Tooltip voor desktop
        });
        // Voeg '(Slagen)' toe voor de duidelijkheid
        const smallText = document.createElement('span');
        smallText.textContent = ' (Slagen)';
        smallText.style.fontSize = '0.8em';
        smallText.style.opacity = '0.8';
        header.appendChild(smallText);
        
        thead.appendChild(header);
        
        tbody.querySelectorAll('.hole-row').forEach(row => {
            const cell = row.insertCell(); 
            // Gebruik de naam van de speler als label voor mobiele weergave
            cell.dataset.label = name;
            cell.innerHTML = `<input type="number" class="score-input" min="1" data-player="${playerCount}" placeholder="Slagen">`; // Placeholder toegevoegd
            cell.querySelector('input').addEventListener('input', () => { saveGameState(); });
        });
        if (doSave) { saveGameState(); }
    }
    function toggleHoleLock(button) { const row = button.closest('.hole-row'); if (row.classList.toggle('locked')) { const scores = row.querySelectorAll('.score-input'); const allFilled = scores.length > 0 && Array.from(scores).every(input => input.value.trim() !== ''); if (!allFilled) { alert('Vul eerst de scores voor alle spelers in.'); row.classList.remove('locked'); return; } button.textContent = 'Heropenen'; button.classList.add('reopen-btn'); } else { button.textContent = 'Sluiten'; button.classList.remove('reopen-btn'); } saveGameState(); }
    function toggleHoleFocus(button) { const clickedRow = button.closest('.hole-row'); const wasActive = clickedRow.classList.contains('active-hole'); document.querySelectorAll('.active-hole').forEach(row => row.classList.remove('active-hole')); if (!wasActive) clickedRow.classList.add('active-hole'); updateMarkers(); saveGameState(); }
    function navigateToHole(button) { const row = button.closest('.hole-row'); const location = row.querySelector('.location-input').value; if (location) window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location)}&travelmode=walking`, '_blank'); else alert('Voer eerst een locatie in voor deze hole.'); }
    function updateDarkModeIcon(isDark) { darkModeIcon.innerHTML = isDark ? ICONS.sun : ICONS.moon; }
    
    // 5. SETUP SCREEN LOGIC
    function renderSetupPlayerList() {
        playerSetupList.innerHTML = '';
        setupPlayers.forEach((name, index) => {
            const li = document.createElement('li');
            li.textContent = name;
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Verwijder';
            removeBtn.style.width = 'auto';
            removeBtn.style.backgroundColor = '#757575';
            removeBtn.onclick = () => {
                setupPlayers.splice(index, 1);
                renderSetupPlayerList();
            };
            li.appendChild(removeBtn);
            playerSetupList.appendChild(li);
        });
        startGameBtn.disabled = setupPlayers.length === 0;
    }

    addPlayerSetupBtn.addEventListener('click', () => {
        const name = playerSetupNameInput.value.trim();
        if (name && !setupPlayers.includes(name)) {
            setupPlayers.push(name);
            playerSetupNameInput.value = '';
            renderSetupPlayerList();
        }
        playerSetupNameInput.focus();
    });

    // 6. BUTTON EVENT LISTENERS
    startGameBtn.addEventListener('click', () => {
        const count = parseInt(holeCountInput.value);
        setupScreen.style.display = 'none'; gameScreen.style.display = 'block';
        // CreÃ«er de basis header
        thead.innerHTML = '<tr><th style="width: 40px;">#</th><th>Hole</th><th>Locatie & Nav.</th><th>Opdracht</th><th>Acties</th></tr>';
        
        generateHoleRows(count);
        // Voeg de spelers toe aan de header vanuit de setup-lijst
        setupPlayers.forEach(name => addPlayer(name, false));

        initializeDragAndDrop();
        google.maps.event.trigger(map, 'resize'); 
        saveGameState();
    });
    
    showTotalsBtn.addEventListener('click', () => {
        if (playerCount === 0) { alert('Er zijn geen spelers in het spel!'); return; }
        const scores = [];
        for (let i = 1; i <= playerCount; i++) {
            let total = 0;
            document.querySelectorAll(`.score-input[data-player='${i}']`).forEach(input => { total += parseInt(input.value) || 0; });
            scores.push({ name: thead.children[4 + i].textContent, score: total });
        }
        scores.sort((a, b) => a.score - b.score);
        const minScore = scores.length > 0 ? scores[0].score : 0;
        const maxScore = scores.length > 0 ? scores[scores.length - 1].score : 0;

        rankingList.innerHTML = '';
        scores.forEach(player => {
            let emoji = '';
            if (player.score === minScore) emoji = 'ðŸ‘‘';
            if (player.score === maxScore && minScore !== maxScore) emoji = 'ðŸ’©';
            const item = document.createElement('li');
            item.className = 'ranking-item';
            item.innerHTML = `<span class="ranking-emoji">${emoji}</span> <span class="ranking-name">${player.name}</span> <span class="ranking-score">${player.score}</span>`;
            rankingList.appendChild(item);
        });
        scoreboardModal.style.display = 'block';
    });
    
    resetBtn.addEventListener('click', () => { if (confirm('Weet je zeker dat je het hele spel wilt resetten? Alle data wordt gewist.')) { localStorage.clear(); window.location.reload(); } });
    darkModeToggle.addEventListener('click', () => { const isDark = docHtml.classList.toggle('dark-mode'); updateDarkModeIcon(isDark); localStorage.setItem('pubgolfDarkMode', isDark); });
    rulesBtn.addEventListener('click', () => { rulesModal.style.display = 'block'; });
    closeRules.addEventListener('click', () => { rulesModal.style.display = 'none'; saveGameState(); });
    shareBtn.addEventListener('click', () => { qrcodeContainer.innerHTML = ''; const qr = qrcode(0, 'H'); qr.addData(window.location.href); qr.make(); qrcodeContainer.innerHTML = qr.createCanvasTag(4, 8); shareModal.style.display = 'block'; });
    closeShare.addEventListener('click', () => { shareModal.style.display = 'none'; });
    closeScoreboard.addEventListener('click', () => { scoreboardModal.style.display = 'none'; });
    window.addEventListener('click', e => { if (e.target == rulesModal) { rulesModal.style.display = 'none'; saveGameState(); } if (e.target == shareModal) shareModal.style.display = 'none'; if(e.target == scoreboardModal) { scoreboardModal.style.display = 'none';} });
});
</script>

<script>
if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js'); }); }
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfhhaBxRnrPGH8UWRPV9-fSroam59F9XY&libraries=places&callback=initMap"></script>
</body>
</html>
