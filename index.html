<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finale Pubgolf Scorekaart</title>
    <!-- Voeg SortableJS library toe voor drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { text-align: center; color: #2E7D32; }
        .print-only { display: none; }
        #map { height: 400px; width: 100%; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; }
        #route-info { text-align: center; font-size: 1.2em; font-weight: bold; color: #1976D2; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; padding: 15px; background-color: #f9f9f9; border-radius: 8px; }
        input[type="text"], input[type="number"], button { padding: 10px 15px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        button { background-color: #4CAF50; color: white; cursor: pointer; border: none; transition: background-color 0.3s; font-weight: bold; }
        button:hover { background-color: #45a049; }
        #reset-btn { background-color: #d32f2f; } #reset-btn:hover { background-color: #b71c1c; }
        #print-btn { background-color: #607D8B; } #print-btn:hover { background-color: #455A64; }
        #show-totals-btn { background-color: #FF8F00; } #show-totals-btn:hover { background-color: #EF6C00; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background-color: #4CAF50; color: white; position: sticky; top: 0; z-index: 10; }
        .hole-row { cursor: move; /* Geeft aan dat je kunt slepen */ }
        .total-row { font-weight: bold; font-size: 1.1em; }
        tfoot { display: none; }
        .hole-row.locked { background-color: #e0e0e0; cursor: default; }
        .hole-row.locked input { pointer-events: none; background-color: #e0e0e0; border-color: #e0e0e0; }
        .hole-row.locked .score-input { color: transparent; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .reopen-btn { background-color: #FFC107 !important; color: black !important; }
        #setup-screen { text-align: center; padding: 40px 20px; }
        #game-screen { display: none; }

        @media print {
            body { background-color: white; padding: 0; font-size: 10pt; }
            .container { box-shadow: none; padding: 0; margin: 0; max-width: 100%; }
            .controls, #setup-screen, #map, #route-info, .actions-cell, .actions-header, .location-cell, .location-header, button { display: none !important; }
            .print-only { display: block; text-align: center; margin-bottom: 20px; }
            h1 { display: none; }
            table { margin: 0; box-shadow: none; width: 100%; }
            th { background-color: #4CAF50 !important; color: white !important; -webkit-print-color-adjust: exact; }
            input { border: none !important; background: transparent !important; color: black !important; text-shadow: none !important; width: 100% !important; text-align: center; padding: 0; font-size: inherit; }
            tfoot { display: table-footer-group !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="winner-container" class="print-only"></div>
    <h1>Pubgolf Scorekaart</h1>
    
    <div id="setup-screen">
        <h2>Start een Nieuw Spel</h2>
        <p>Hoeveel pubs (holes) gaan jullie bezoeken?</p>
        <div class="controls">
            <input type="number" id="hole-count-input" min="6" max="16" value="9">
            <button id="start-game-btn">Start Pubgolf</button>
        </div>
    </div>

    <div id="game-screen">
        <div id="map"></div>
        <h2 id="route-info">Totale loopafstand: -</h2>
        <div class="controls">
            <input type="text" id="player-name" placeholder="Naam speler">
            <button id="add-player-btn">Speler toevoegen</button>
        </div>
        <div class="controls">
             <button id="show-totals-btn">Toon Tussenstand</button>
             <button id="print-btn">Afdrukken / PDF</button>
             <button id="reset-btn">Nieuw Spel</button>
        </div>

        <table id="scoreboard">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Hole</th>
                    <th class="location-header">Locatie</th>
                    <th class="actions-header">Acties</th>
                </tr>
            </thead>
            <tbody id="scoreboard-body"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="4"><strong>Totaal</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === 1. DOM SELECTORS & STATE MANAGEMENT ===
    const setupScreen = document.getElementById('setup-screen'), gameScreen = document.getElementById('game-screen');
    const holeCountInput = document.getElementById('hole-count-input'), startGameBtn = document.getElementById('start-game-btn');
    const addPlayerBtn = document.getElementById('add-player-btn'), resetBtn = document.getElementById('reset-btn');
    const printBtn = document.getElementById('print-btn'), showTotalsBtn = document.getElementById('show-totals-btn');
    const playerNameInput = document.getElementById('player-name'), routeInfo = document.getElementById('route-info');
    const thead = document.querySelector('#scoreboard thead tr'), tbody = document.getElementById('scoreboard-body');
    const tfoot = document.querySelector('#scoreboard tfoot');
    let playerCount = 0, map, directionsService, directionsRenderer;
    let markers = [], holeLocations = {};

    // === 2. SETUP & INITIALIZATION ===
    window.initMap = function() {
        map = new google.maps.Map(document.getElementById('map'), { center: { lat: 52.1326, lng: 5.2913 }, zoom: 7, mapTypeControl: false, streetViewControl: false });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#1976D2', strokeOpacity: 0.8, strokeWeight: 6 }, map: map });
    };

    startGameBtn.addEventListener('click', () => {
        const count = parseInt(holeCountInput.value);
        if (count >= 6 && count <= 16) {
            setupScreen.style.display = 'none'; gameScreen.style.display = 'block';
            generateHoleRows(count); initializeDragAndDrop();
            google.maps.event.trigger(map, 'resize');
        } else {
            alert('Kies een aantal holes tussen 6 en 16.');
        }
    });

    function generateHoleRows(count) {
        tbody.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const row = tbody.insertRow();
            row.className = 'hole-row';
            row.dataset.originalIndex = i - 1;
            row.innerHTML = `
                <td data-label="#">${i}</td>
                <td data-label="Hole"><input type="text" class="hole-input" placeholder="Naam Hole ${i}"></td>
                <td data-label="Locatie" class="location-cell"><input type="text" class="location-input" placeholder="Zoek locatie..."></td>
                <td data-label="Acties" class="actions-cell"><button class="lock-btn">Sluiten</button></td>
            `;
            initializeAutocomplete(row.querySelector('.location-input'), i - 1);
            row.querySelector('.lock-btn').addEventListener('click', (e) => toggleHoleLock(e.target));
        }
    }

    function initializeDragAndDrop() {
        new Sortable(tbody, { animation: 150, handle: '.hole-row', onEnd: updateVisualsAfterDrag });
    }
    
    // === 3. GOOGLE MAPS & ROUTE FUNCTIONS ===
    function initializeAutocomplete(input, originalIndex) {
        const autocomplete = new google.maps.places.Autocomplete(input, { fields: ["formatted_address", "geometry", "name"], types: ["establishment", "geocode"] });
        autocomplete.bindTo("bounds", map);
        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) return;
            input.value = place.formatted_address || place.name;
            holeLocations[originalIndex] = place.geometry.location;
            updateVisualsAfterDrag();
        });
    }
    
    function updateVisualsAfterDrag() {
        updateVisualHoleNumbers();
        calculateRouteAndDistance();
        updateMarkers();
    }
    
    function calculateRouteAndDistance() {
        const waypoints = [];
        tbody.querySelectorAll('.hole-row').forEach(row => {
            const index = row.dataset.originalIndex;
            if (holeLocations[index]) waypoints.push(holeLocations[index]);
        });

        if (waypoints.length < 2) {
            directionsRenderer.setDirections({routes: []});
            routeInfo.textContent = 'Totale loopafstand: -';
            return;
        }

        const request = {
            origin: waypoints[0], destination: waypoints[waypoints.length - 1],
            waypoints: waypoints.slice(1, -1).map(loc => ({ location: loc, stopover: true })),
            travelMode: 'WALKING'
        };

        directionsService.route(request, (result, status) => {
            if (status == 'OK') {
                directionsRenderer.setDirections(result);
                let totalDistance = 0, totalDuration = 0;
                result.routes[0].legs.forEach(leg => {
                    totalDistance += leg.distance.value;
                    totalDuration += leg.duration.value;
                });
                const totalMinutes = Math.round(totalDuration / 60);
                routeInfo.textContent = `Totale loopafstand: ${(totalDistance / 1000).toFixed(1)} km (ongeveer ${totalMinutes} min lopen)`;
            }
        });
    }
    
    function updateMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        tbody.querySelectorAll('.hole-row').forEach((row, visualIndex) => {
            const originalIndex = row.dataset.originalIndex;
            if (holeLocations[originalIndex]) {
                markers.push(new google.maps.Marker({ map, position: holeLocations[originalIndex], label: (visualIndex + 1).toString(), title: row.querySelector('.hole-input').value || `Hole ${visualIndex + 1}` }));
            }
        });
    }

    function updateVisualHoleNumbers() {
        tbody.querySelectorAll('.hole-row').forEach((row, index) => { row.cells[0].textContent = index + 1; });
    }
    
    // === 4. PLAYER & SCORE FUNCTIONS ===
    addPlayerBtn.addEventListener('click', () => {
        const playerName = playerNameInput.value.trim();
        if (playerName) {
            playerCount++;
            thead.appendChild(Object.assign(document.createElement('th'), { textContent: playerName }));
            tbody.querySelectorAll('.hole-row').forEach(row => {
                const cell = row.insertCell(); cell.dataset.label = playerName;
                cell.innerHTML = `<input type="number" class="score-input" min="1" data-player="${playerCount}">`;
                cell.querySelector('input').addEventListener('input', updateTotalScores);
            });
            const totalRow = tfoot.querySelector('.total-row');
            const totalCell = totalRow.insertCell();
            totalCell.textContent = '0'; totalCell.id = `total-player-${playerCount}`;
            playerNameInput.value = '';
        }
    });

    function updateTotalScores() {
        for (let i = 1; i <= playerCount; i++) {
            let total = 0;
            document.querySelectorAll(`.score-input[data-player='${i}']`).forEach(input => { total += parseInt(input.value) || 0; });
            const totalCell = document.getElementById(`total-player-${i}`);
            if (totalCell) totalCell.textContent = total;
        }
    }
    
    function toggleHoleLock(button) {
        const row = button.closest('.hole-row');
        if (row.classList.toggle('locked')) {
            const scores = row.querySelectorAll('.score-input');
            const allFilled = scores.length > 0 && Array.from(scores).every(input => input.value.trim() !== '');
            if (!allFilled) {
                alert('Vul eerst de scores voor alle spelers in voordat je de hole sluit.');
                row.classList.remove('locked');
                return;
            }
            button.textContent = 'Heropenen'; button.classList.add('reopen-btn');
        } else {
            button.textContent = 'Sluiten'; button.classList.remove('reopen-btn');
        }
    }

    // === 5. UI EVENT LISTENERS ===
    printBtn.addEventListener('click', () => {
        updateTotalScores();
        const winnerContainer = document.getElementById('winner-container');
        winnerContainer.innerHTML = '';

        if (playerCount > 0) {
            let lowestScore = Infinity, winners = [];
            for (let i = 1; i <= playerCount; i++) {
                const score = parseInt(document.getElementById(`total-player-${i}`).textContent);
                if (score < lowestScore) lowestScore = score;
            }
            for (let i = 1; i <= playerCount; i++) {
                const score = parseInt(document.getElementById(`total-player-${i}`).textContent);
                if (score === lowestScore) winners.push(thead.children[i + 3].textContent);
            }
            if (winners.length > 0) {
                const title = document.createElement('h2');
                title.textContent = `${winners.length > 1 ? 'Winnaars' : 'Winnaar'}: ${winners.join(', ')} met een score van ${lowestScore}!`;
                winnerContainer.appendChild(title);
            }
        }
        window.print();
    });
    
    showTotalsBtn.addEventListener('click', () => {
        const isVisible = tfoot.style.display !== 'none';
        if (isVisible) {
            tfoot.style.display = 'none'; showTotalsBtn.textContent = 'Toon Tussenstand';
        } else {
            if (confirm('Weet je zeker dat je de tussenstand wilt zien? Dit kan de spanning verminderen!')) {
                tfoot.style.display = 'table-footer-group'; showTotalsBtn.textContent = 'Verberg Tussenstand';
            }
        }
    });

    resetBtn.addEventListener('click', () => { if (confirm('Weet je zeker dat je het hele spel wilt resetten?')) window.location.reload(); });
});
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhEQgJZh416N7_Rltca6kXynD3krDyqyg&libraries=places&callback=initMap"></script>

</body>
</html>