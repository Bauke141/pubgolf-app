<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pubgolf App</title>
    <!-- PWA / Mobiele App Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Pubgolf">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { text-align: center; color: #2E7D32; margin-top: 10px; margin-bottom: 15px; }
        .print-only { display: none; }
        #map { height: 350px; width: 100%; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; }
        #route-info { text-align: center; font-size: 1.1em; font-weight: bold; color: #1976D2; margin-bottom: 20px; }
        .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .controls-row { display: flex; gap: 10px; }
        input[type="text"], input[type="number"], button { width: 100%; padding: 12px 15px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        input[type="text"] { flex-grow: 1; }
        button { background-color: #4CAF50; color: white; cursor: pointer; border: none; transition: background-color 0.3s; font-weight: bold; }
        button:hover { background-color: #45a049; }
        #reset-btn { background-color: #d32f2f; } #reset-btn:hover { background-color: #b71c1c; }
        #print-btn { background-color: #607D8B; } #print-btn:hover { background-color: #455A64; }
        #show-totals-btn { background-color: #FF8F00; } #show-totals-btn:hover { background-color: #EF6C00; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background-color: #4CAF50; color: white; position: sticky; top: 0; z-index: 10; }
        .hole-row { cursor: move; }
        .total-row { font-weight: bold; font-size: 1.1em; }
        tfoot { display: none; }
        .hole-row.locked { background-color: #e0e0e0; cursor: default; }
        .hole-row.locked input { pointer-events: none; background-color: #e0e0e0; border-color: #e0e0e0; }
        .hole-row.locked .score-input { color: transparent; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .reopen-btn { background-color: #FFC107 !important; color: black !important; }
        #setup-screen { text-align: center; padding: 40px 20px; }
        #game-screen { display: none; }

        /* === NIEUWE & VERBETERDE MOBIELE STIJLEN === */
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 45% !important; text-align: right !important; min-height: 44px; display: flex; align-items: center; justify-content: flex-end; }
            td:before { content: attr(data-label); position: absolute; left: 10px; width: 40%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; }
            td:last-child { border-bottom: none; }
            .score-input { width: 80px !important; padding: 8px; text-align: center; }
        }
        @media (min-width: 769px) {
            .controls { flex-direction: row; }
        }

        @media print { /* ... (Print stijlen blijven ongewijzigd) ... */ }
    </style>
</head>
<body>
    <div class="container">
        <div id="winner-container" class="print-only"></div>
        <h1>Pubgolf App</h1>
        <div id="setup-screen">
            <h2>Start een Nieuw Spel</h2>
            <p>Hoeveel pubs (holes) gaan jullie bezoeken?</p>
            <div class="controls">
                <input type="number" id="hole-count-input" min="6" max="16" value="9">
                <button id="start-game-btn">Start Pubgolf</button>
            </div>
        </div>
        <div id="game-screen">
            <div id="map"></div>
            <h2 id="route-info">Totale loopafstand: -</h2>
            <div class="controls">
                <div class="controls-row">
                    <input type="text" id="player-name" placeholder="Naam speler">
                    <button id="add-player-btn">Voeg toe</button>
                </div>
                <div class="controls-row">
                     <button id="show-totals-btn">Tussenstand</button>
                     <button id="print-btn">PDF</button>
                     <button id="reset-btn">Nieuw Spel</button>
                </div>
            </div>
            <table id="scoreboard">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Hole</th>
                        <th class="location-header">Locatie</th>
                        <th class="actions-header">Acties</th>
                    </tr>
                </thead>
                <tbody id="scoreboard-body"></tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4"><strong>Totaal</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

<script>
// === VOLLEDIG HERSCHREVEN JAVASCRIPT ===
document.addEventListener('DOMContentLoaded', () => {
    // 1. DOM SELECTORS & STATE
    const setupScreen = document.getElementById('setup-screen'), gameScreen = document.getElementById('game-screen');
    const holeCountInput = document.getElementById('hole-count-input'), startGameBtn = document.getElementById('start-game-btn');
    const addPlayerBtn = document.getElementById('add-player-btn'), resetBtn = document.getElementById('reset-btn');
    const printBtn = document.getElementById('print-btn'), showTotalsBtn = document.getElementById('show-totals-btn');
    const playerNameInput = document.getElementById('player-name'), routeInfo = document.getElementById('route-info');
    const thead = document.querySelector('#scoreboard thead tr'), tbody = document.getElementById('scoreboard-body');
    const tfoot = document.querySelector('#scoreboard tfoot');
    let map, directionsService, directionsRenderer, playerCount = 0, markers = [], holeLocations = {};

    // 2. INITIALIZATION
    window.initMap = function() {
        map = new google.maps.Map(document.getElementById('map'), { center: { lat: 52.1326, lng: 5.2913 }, zoom: 7, mapTypeControl: false, streetViewControl: false });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#1976D2', strokeOpacity: 0.8, strokeWeight: 6 }, map: map });
        loadGameState();
    };

    // 3. GAME SETUP
    startGameBtn.addEventListener('click', () => {
        const count = parseInt(holeCountInput.value);
        if (count >= 6 && count <= 16) {
            setupScreen.style.display = 'none'; gameScreen.style.display = 'block';
            generateHoleRows(count); initializeDragAndDrop();
            google.maps.event.trigger(map, 'resize'); saveGameState();
        } else { alert('Kies een aantal holes tussen 6 en 16.'); }
    });

    // 4. DATA PERSISTENCE (SAVE & LOAD)
    function saveGameState() {
        const state = { players: [], holes: [], holeLocations, playerCount };
        thead.querySelectorAll('th').forEach((th, i) => { if(i > 3) state.players.push(th.textContent); });
        tbody.querySelectorAll('.hole-row').forEach(row => {
            const holeData = {
                originalIndex: row.dataset.originalIndex, name: row.querySelector('.hole-input').value,
                location: row.querySelector('.location-input').value, locked: row.classList.contains('locked'), scores: {}
            };
            row.querySelectorAll('.score-input').forEach(input => { holeData.scores[input.dataset.player] = input.value; });
            state.holes.push(holeData);
        });
        localStorage.setItem('pubgolfGameState', JSON.stringify(state));
    }

    function loadGameState() {
        const savedState = localStorage.getItem('pubgolfGameState');
        if (!savedState) return;
        const state = JSON.parse(savedState);
        if (state.holes.length === 0) return;

        setupScreen.style.display = 'none'; gameScreen.style.display = 'block';
        holeLocations = state.holeLocations || {};
        playerCount = state.playerCount || 0;

        // Herbouw spelers
        state.players.forEach(name => addPlayer(name, false));
        // Herbouw holes
        state.holes.forEach(holeData => tbody.appendChild(createRowFromData(holeData, state.players)));

        initializeDragAndDrop(); updateTotalScores(); updateVisualsAfterDrag(false);
    }

    function createRowFromData(holeData, players) {
        const row = document.createElement('tr');
        row.className = 'hole-row'; if(holeData.locked) row.classList.add('locked');
        row.dataset.originalIndex = holeData.originalIndex;
        row.innerHTML = `<td data-label="#">-</td><td data-label="Hole"><input type="text" class="hole-input" value="${holeData.name || ''}"></td><td data-label="Locatie"><input type="text" class="location-input" value="${holeData.location || ''}"></td><td data-label="Acties"><button class="lock-btn">${holeData.locked ? 'Heropenen' : 'Sluiten'}</button></td>`;
        if(holeData.locked) row.querySelector('.lock-btn').classList.add('reopen-btn');
        players.forEach((p, i) => {
            const pIdx = i + 1;
            const cell = row.insertCell(); cell.dataset.label = p;
            cell.innerHTML = `<input type="number" class="score-input" min="1" data-player="${pIdx}" value="${holeData.scores[pIdx] || ''}">`;
        });
        // Koppel events opnieuw
        initializeAutocomplete(row.querySelector('.location-input'), holeData.originalIndex);
        row.querySelectorAll('input').forEach(input => input.addEventListener('input', saveGameState));
        row.querySelector('.lock-btn').addEventListener('click', e => toggleHoleLock(e.target));
        return row;
    }

    // 5. CORE FUNCTIONS (Generate, Drag, Maps, Players, Scores)
    function generateHoleRows(count) {
        tbody.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const row = tbody.insertRow(); row.className = 'hole-row'; row.dataset.originalIndex = i - 1;
            row.innerHTML = `<td data-label="#">${i}</td><td data-label="Hole"><input type="text" class="hole-input" placeholder="Hole ${i}"></td><td data-label="Locatie"><input type="text" class="location-input" placeholder="Zoek locatie..."></td><td data-label="Acties"><button class="lock-btn">Sluiten</button></td>`;
            initializeAutocomplete(row.querySelector('.location-input'), i - 1);
            row.querySelector('.lock-btn').addEventListener('click', e => toggleHoleLock(e.target));
            row.querySelectorAll('input').forEach(input => input.addEventListener('input', saveGameState));
        }
    }
    function initializeDragAndDrop() { new Sortable(tbody, { animation: 150, handle: '.hole-row', onEnd: updateVisualsAfterDrag }); }
    function initializeAutocomplete(input, originalIndex) {
        const autocomplete = new google.maps.places.Autocomplete(input, { fields: ["formatted_address", "geometry", "name"], types: ["establishment", "geocode"] });
        autocomplete.bindTo("bounds", map);
        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace(); if (!place.geometry || !place.geometry.location) return;
            input.value = place.formatted_address || place.name;
            // BUGFIX: Sla locaties op als simpele objecten, niet als Google Maps objecten
            holeLocations[originalIndex] = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
            updateVisualsAfterDrag();
        });
    }
    function updateVisualsAfterDrag(doSave = true) {
        updateVisualHoleNumbers(); calculateRouteAndDistance(); updateMarkers();
        if (doSave) saveGameState();
    }
    function calculateRouteAndDistance() {
        const waypoints = [];
        tbody.querySelectorAll('.hole-row').forEach(row => { const index = row.dataset.originalIndex; if (holeLocations[index]) waypoints.push(holeLocations[index]); });
        if (waypoints.length < 2) { directionsRenderer.setDirections({routes: []}); routeInfo.textContent = 'Totale loopafstand: -'; return; }
        const request = { origin: waypoints[0], destination: waypoints[waypoints.length - 1], waypoints: waypoints.slice(1, -1).map(loc => ({ location: loc, stopover: true })), travelMode: 'WALKING' };
        directionsService.route(request, (result, status) => {
            if (status == 'OK') {
                directionsRenderer.setDirections(result); let totalDistance = 0, totalDuration = 0;
                result.routes[0].legs.forEach(leg => { totalDistance += leg.distance.value; totalDuration += leg.duration.value; });
                const totalMinutes = Math.round(totalDuration / 60);
                routeInfo.textContent = `Afstand: ${(totalDistance / 1000).toFixed(1)} km (~${totalMinutes} min lopen)`;
            }
        });
    }
    function updateMarkers() {
        markers.forEach(marker => marker.setMap(null)); markers = [];
        tbody.querySelectorAll('.hole-row').forEach((row, visualIndex) => {
            const originalIndex = row.dataset.originalIndex;
            if (holeLocations[originalIndex]) { markers.push(new google.maps.Marker({ map, position: holeLocations[originalIndex], label: (visualIndex + 1).toString(), title: row.querySelector('.hole-input').value || `Hole ${visualIndex + 1}` })); }
        });
    }
    function updateVisualHoleNumbers() { tbody.querySelectorAll('.hole-row').forEach((row, index) => { row.cells[0].textContent = index + 1; }); }
    function addPlayer(name, doSave = true) {
        playerCount++;
        thead.appendChild(Object.assign(document.createElement('th'), { textContent: name }));
        tbody.querySelectorAll('.hole-row').forEach(row => {
            const cell = row.insertCell(); cell.dataset.label = name;
            cell.innerHTML = `<input type="number" class="score-input" min="1" data-player="${playerCount}">`;
            cell.querySelector('input').addEventListener('input', () => { updateTotalScores(); saveGameState(); });
        });
        const totalRow = tfoot.querySelector('.total-row');
        const totalCell = totalRow.insertCell(); totalCell.textContent = '0'; totalCell.id = `total-player-${playerCount}`;
        if (doSave) { updateTotalScores(); saveGameState(); }
    }
    function updateTotalScores() {
        for (let i = 1; i <= playerCount; i++) {
            let total = 0; document.querySelectorAll(`.score-input[data-player='${i}']`).forEach(input => { total += parseInt(input.value) || 0; });
            const totalCell = document.getElementById(`total-player-${i}`); if (totalCell) totalCell.textContent = total;
        }
    }
    function toggleHoleLock(button) {
        const row = button.closest('.hole-row');
        if (row.classList.toggle('locked')) {
            const scores = row.querySelectorAll('.score-input');
            const allFilled = scores.length > 0 && Array.from(scores).every(input => input.value.trim() !== '');
            if (!allFilled) { alert('Vul eerst de scores voor alle spelers in.'); row.classList.remove('locked'); return; }
            button.textContent = 'Heropenen'; button.classList.add('reopen-btn');
        } else { button.textContent = 'Sluiten'; button.classList.remove('reopen-btn'); }
        saveGameState();
    }
    // 6. BUTTON EVENT LISTENERS
    addPlayerBtn.addEventListener('click', () => { const name = playerNameInput.value.trim(); if(name) { addPlayer(name); playerNameInput.value = ''; } });
    showTotalsBtn.addEventListener('click', () => {
        const isVisible = tfoot.style.display !== 'none';
        if (isVisible) { tfoot.style.display = 'none'; showTotalsBtn.textContent = 'Tussenstand'; }
        else { if (confirm('Weet je zeker dat je de tussenstand wilt zien?')) { tfoot.style.display = 'table-footer-group'; showTotalsBtn.textContent = 'Verberg Stand'; } }
    });
    printBtn.addEventListener('click', () => { /* ... (onveranderd) ... */ });
    resetBtn.addEventListener('click', () => { if (confirm('Weet je zeker dat je het hele spel wilt resetten? Alle data wordt gewist.')) { localStorage.removeItem('pubgolfGameState'); window.location.reload(); } });
});
</script>

<script>
// NIEUW: Service Worker registratie
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js').then(registration => {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, err => {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhEQgJZh416N7_Rltca6kXynD3krDyqyg&libraries=places&callback=initMap"></script>
</body>
</html>
